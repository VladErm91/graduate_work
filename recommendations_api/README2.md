#### Общая архитектура
Проект представляет собой микросервисную систему рекомендаций фильмов, реализованную на базе FastAPI с использованием MongoDB для хранения данных, MinIO для хранения моделей, Redis для очередей задач и метаданных, RQ для асинхронной обработки, и RQ Scheduler для планирования задач. Основной сервис (`recommendation_service`) управляет обучением моделей машинного обучения (ALS и LightFM), генерацией персонализированных рекомендаций и периодическим обновлением данных. Все компоненты работают в контейнерах, настроенных через `docker-compose.yml`.

#### Компоненты системы
1. **FastAPI (recommendation_service)**:
   - **Роль**: Центральный веб-сервис, предоставляющий API для получения рекомендаций и добавления данных, а также управляющий жизненным циклом приложения.
   - **Файлы**:
     - `main.py`: Точка входа, настройка жизненного цикла (`lifespan`), маршруты API, запуск планировщика.
     - `api/v1/recommend.py`: Эндпоинты API (`/recommendations/{user_id}`, `/watched`).
     - `ml/recommendation_model.py`: Логика моделей (ALS и LightFM), обучение и рекомендации.
     - `workers/tasks.py`: Фоновые задачи (полное и частичное обучение).
     - `scheduler.py`: Планирование задач через RQ Scheduler.
   - **Функции**:
     - При старте проверяет наличие данных в `watched_movies` и моделей в MinIO, запускает обучение, если нужно.
     - Обрабатывает запросы на рекомендации и добавление просмотров.
     - Запускает планировщик для периодического обучения.

2. **MongoDB**:
   - **Роль**: Хранилище данных о пользователях, фильмах и взаимодействиях.
   - **Коллекции**:
     - `users`: Пользователи (`_id`, `username`).
     - `movies`: Фильмы (`_id`, `title`, `genres`, `rating`, `creation_date`).
     - `watched_movies`: Просмотры (`user_id`, `movie_id`, `complete`, `timestamp`).
     - `likes`: Оценки (`user_id`, `movie_id`, `rating`, `timestamp`).
     - `bookmarks`: Закладки (`user_id`, `movie_id`, `timestamp`).
   - **Взаимодействие**: FastAPI использует `motor` для асинхронных запросов.

3. **MinIO**:
   - **Роль**: Хранилище обученных моделей в формате pickle.
   - **Объекты**:
     - `als_model.pkl`: Модель ALS с матрицей и метаинформацией.
     - `lightfm_model.pkl`: Модель LightFM с матрицей и признаками.
   - **Взаимодействие**: `recommendation_model.py` загружает и сохраняет модели через MinIO SDK.

4. **Redis**:
   - **Роль**: Хранит очереди задач (RQ), метаданные (`last_train_time`) и управляет планировщиком (RQ Scheduler).
   - **Взаимодействие**: Используется RQ Worker, Scheduler и FastAPI для координации задач.

5. **RQ Worker**:
   - **Роль**: Выполнение фоновых задач (обучение моделей).
   - **Файл**: `workers/tasks.py`.
   - **Функции**:
     - `train_model_async`: Полное или частичное обучение моделей с параметрами `partial` и `train_als`.

6. **RQ Scheduler**:
   - **Роль**: Планирование периодических задач.
   - **Файл**: `scheduler.py`.
   - **Задачи**:
     - Полное обучение (`train_model`, `partial=False`, `train_als=True`) — каждый день в 00:00.
     - Частичное обучение (`train_model`, `partial=True`, `train_als=False`) — каждые 15 минут.
     - Обновление рекомендаций (`update_all_recommendations`) — каждый день в 00:30.

7. **Генерация данных (опционально)**:
   - **Файл**: `ml/generate_mongo_data.py`.
   - **Роль**: Заполнение MongoDB тестовыми данными.

---

#### Взаимодействие сервисов
1. **Запуск системы**:
   - Docker Compose поднимает контейнеры: `fastapi`, `mongo`, `minio`, `redis`, `rq_worker`, и запускает `scheduler.py` в отдельном процессе.
   - `main.py` в `fastapi` выполняет `lifespan`:
     - Проверяет наличие записей в `watched_movies` (MongoDB).
     - Проверяет загрузку моделей из MinIO (`als_loaded`, `lightfm_loaded`).
     - Если данные есть и модели отсутствуют, ставит задачу `train_model(partial=False, train_als=True)` в очередь Redis (RQ).
     - Запускает планировщик (`scheduler.py`) для периодических задач.

2. **Обучение моделей**:
   - **Периодическое обучение**:
     - `scheduler.py` через RQ Scheduler:
       - Каждые 15 минут: `train_model(partial=True, train_als=False)` → `train_model_async` проверяет новые взаимодействия в MongoDB с `timestamp > last_train_time`. Если есть, вызывает `partial_train` (только LightFM).
       - Ежедневно в 00:00: `train_model(partial=False, train_als=True)` → `train_model_async` вызывает полное обучение `train` (ALS и LightFM).
     - Результаты сохраняются в MinIO, `last_train_time` обновляется в Redis.
   - **RQ Worker**:
     - Обрабатывает задачи из очереди Redis, выполняя `train_model_async`.

3. **Получение рекомендаций**:
   - Клиент отправляет `GET /recommendations/{user_id}`.
   - `recommend.py` валидирует `user_id` и вызывает `recommendation_model.get_recommendations`:
     - Запрашивает просмотры пользователя из MongoDB.
     - Использует модели из MinIO (ALS или LightFM) для генерации рекомендаций.
     - Подмешивает новые фильмы (по `timestamp` за последний месяц) из MongoDB.
     - Возвращает результат.

4. **Добавление данных**:
   - Клиент отправляет `POST /watched` с данными о просмотре.
   - `recommend.py` добавляет запись в `watched_movies` (MongoDB) и может опционально вызвать `train_model(partial=True, train_als=False)` для немедленного частичного обновления.

5. **Обновление рекомендаций**:
   - `scheduler.py` запускает `update_all_recommendations` в 00:30 ежедневно (предположительно обновляет кэш рекомендаций для всех пользователей).

---

#### Последовательность процессов
1. **Инициализация**:
   - FastAPI стартует → Проверка MongoDB → Проверка MinIO → Постановка задачи в Redis (если нужно) → Запуск RQ Scheduler.
2. **Обучение**:
   - RQ Scheduler → Redis (очередь) → RQ Worker → MongoDB (данные) → Обновление моделей → MinIO (сохранение).
   - Частичное: Каждые 15 минут (LightFM).
   - Полное: Ежедневно в 00:00 (ALS и LightFM).
3. **Запрос рекомендаций**:
   - Клиент → FastAPI → MongoDB (просмотры) → MinIO (модели) → Ответ клиенту.
4. **Добавление данных**:
   - Клиент → FastAPI → MongoDB (запись) → (опционально) Redis (задача на частичное обучение).

---

### Текстовая схема (ASCII)

```
+----------------+       +----------------+       +----------------+
|    Client      |       |    FastAPI     |       |    MongoDB     |
|  (curl, app)   |<----->| (recommendation|------>| (users, movies,|
|                |       |   service)     |       |  interactions) |
+----------------+       | - main.py       |       +----------------+
                         | - recommend.py  |
                         | - recommendation_model.py|
                         | - tasks.py      |       +----------------+
                         |                |<----->|    MinIO       |
                         |                |       | (models: ALS,  |
                         +----------------+       |  LightFM)      |
                         |                |       +----------------+
                         |                |
                         |                |       +----------------+
                         |   Scheduler    |<----->|    Redis       |
                         |  (scheduler.py)|       | (RQ queue,     |
                         | - Every 15m:   |       |  last_train_time)|
                         |   partial_train |       +----------------+
                         | - Daily 00:00: |
                         |   full_train   |
                         | - Daily 00:30: |       +----------------+
                         |   update_recs  |------>|    RQ Worker   |
                         |                |       | (tasks.py)     |
                         +----------------+       +----------------+
```

#### Описание схемы
- **Client**: Внешний запросчик.
- **FastAPI**: Центральный сервис, управляет API, обучением и планированием.
- **MongoDB**: Хранит данные.
- **MinIO**: Хранит модели.
- **Redis**: Управляет очередями и метаданными.
- **RQ Scheduler**: Планирует задачи (полное, частичное обучение, обновление рекомендаций).
- **RQ Worker**: Выполняет задачи из очереди.

---

### Ключевые особенности
1. **Частичное обновление**:
   - Выполняется каждые 15 минут через `train_model(partial=True, train_als=False)` для LightFM, если есть новые взаимодействия.
2. **Полное обучение**:
   - Выполняется ежедневно в 00:00 через `train_model(partial=False, train_als=True)` для ALS и LightFM.
3. **Гибкость**:
   - Параметры `partial` и `train_als` позволяют управлять типом обучения.
4. **Автоматизация**:
   - Планировщик (`scheduler.py`) обеспечивает регулярное обновление без ручного вмешательства.

---

### Возможные улучшения
1. **Триггер по событию**:
   - Добавить вызов `train_model(partial=True, train_als=False)` в `POST /watched` для немедленного обновления.
2. **Кэширование**:
   - Сохранять рекомендации в Redis после `update_all_recommendations`.
3. **Мониторинг**:
   - Интеграция с Prometheus/Grafana для отслеживания времени обучения и производительности.

---

### Итог
Система теперь полностью автоматизирована:
- **FastAPI** управляет API и жизненным циклом.
- **MongoDB** хранит данные.
- **MinIO** сохраняет модели.
- **Redis и RQ** обеспечивают асинхронное выполнение задач.
- **RQ Scheduler** запускает частичное обучение каждые 15 минут, полное — раз в день, и обновление рекомендаций.

Приятного использования!